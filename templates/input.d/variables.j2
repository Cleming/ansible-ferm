{% set ferm_tpl_protocol = [] %}
{% if item.protocol is defined %}
{%   if item.protocol is string %}
{%     set _ = ferm_tpl_protocol.append(item.protocol) %}
{%   else %}
{%     for element in item.protocol %}
{%       set _ = ferm_tpl_protocol.append(element) %}
{%     endfor %}
{%   endif %}
{% elif item.protocols is defined %}
{%   if item.protocols is string %}
{%     set _ = ferm_tpl_protocol.append(item.protocols) %}
{%   else %}
{%     for element in item.protocols %}
{%       set _ = ferm_tpl_protocol.append(element) %}
{%     endfor %}
{%   endif %}
{% endif %}
{% set ferm_tpl_state = item.default_state | default('enabled') %}
{% if item.disabled is defined %}
{%   set ferm_tpl_state = 'enabled' %}
{%   if item.disabled is string %}
{%     if item.disabled | bool %}
{%       set ferm_tpl_state = 'disabled' %}
{%     endif %}
{%   else %}
{%     if item.disabled %}
{%       set ferm_tpl_state = 'disabled' %}
{%     endif %}
{%   endif %}
{% elif item.enabled is defined %}
{%   set ferm_tpl_state = 'disabled' %}
{%   if item.enabled is string %}
{%     if item.enabled | bool %}
{%       set ferm_tpl_state = 'enabled' %}
{%     endif %}
{%   else %}
{%     if item.enabled %}
{%       set ferm_tpl_state = 'enabled' %}
{%     endif %}
{%   endif %}
{% else %}
{%   set ferm_tpl_state = 'enabled' %}
{% endif %}
{# Check if saddr is a real IP or a group name #}
{% set ferm_tpl_srcs = [] %}
{% if item.saddr | ipaddr %}
{#   this is an IP #}
{%   set _ = ferm_tpl_srcs.append(item.saddr) %}
{% elif item.saddr in groups %}
{#   we have a group name #}
{%   for hst in groups[item.saddr] %}
{%     for addr in hostvars[hst]['ansible_all_ipv4_addresses'] %}
{%       set _ = ferm_tpl_srcs.append(addr) %}
{%     endfor %}
{%   endfor %}
{% else %}
{#   this is a single host #}
{%   set _ = ferm_tpl_srcs.append(hostvars[item.saddr]['ansible_all_ipv4_addresses']) %}
{% endif %}
